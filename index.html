<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <title>My Savings Pots</title>
  <style>
    body { background-color: #f9fafb; }
    .pot-card { transition: all 0.2s ease-in-out; cursor: pointer; }
    .pot-card:hover { transform: scale(1.02); }
  </style>
</head>
<body class="p-4 font-sans">
  <div class="max-w-xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">ðŸ’° My Savings Pots</h1>
      <button id="expandBtn" onclick="toggleForm()" class="bg-blue-500 text-white w-10 h-10 rounded-full text-xl">ï¼‹</button>
    </div>

    <div id="formContainer" class="mb-6 bg-white p-4 rounded-xl shadow hidden">
      <h2 class="font-semibold mb-2">Create New Pot</h2>
      <input id="potName" type="text" placeholder="Name (e.g., Europe Trip)" class="border p-2 w-full rounded mb-2">
      <input id="potGoal" type="number" placeholder="Goal Amount" class="border p-2 w-full rounded mb-2">
      <button onclick="createPot()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Add Pot</button>
    </div>

    <div id="potsContainer" class="space-y-4"></div>
  </div>

  <script>
    let pots = JSON.parse(localStorage.getItem('pots') || '[]');
    let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

    function savePots() {
      localStorage.setItem('pots', JSON.stringify(pots));
    }

    function saveTransactions() {
      localStorage.setItem('transactions', JSON.stringify(transactions));
    }

    function toggleForm() {
      const form = document.getElementById('formContainer');
      form.classList.toggle('hidden');
    }

    function renderPots() {
      const container = document.getElementById('potsContainer');
      container.innerHTML = '';

      if (pots.length === 0) {
        container.innerHTML = '<div class="text-center bg-white rounded-xl shadow p-6" style="padding: 10px;">' +
          '<button onclick="toggleForm()" class="bg-blue-500 text-white px-4 py-2 rounded">Create First Pot</button>' +
          '</div>';
        return;
      }

      pots.forEach((pot, index) => {
        const percentage = Math.min(100, (pot.amount / pot.goal) * 100);
        const potEl = document.createElement('div');
        potEl.className = 'bg-white rounded-xl shadow p-4 pot-card';
        potEl.ondblclick = () => toggleHistory(index);
        potEl.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <div class="font-semibold">${pot.name}</div>
            <div class="text-sm text-gray-500">â‚¹${pot.amount} / â‚¹${pot.goal}</div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentage}%;"></div>
          </div>
          <div class="flex space-x-2 mb-2">
            <input type="number" id="add-${index}" placeholder="Amount" class="border p-1 rounded w-full">
            <button onclick="addMoney(${index})" class="bg-green-500 text-white px-2 rounded">âž•</button>
            <button onclick="removeMoney(${index})" class="bg-red-500 text-white px-2 rounded">âž–</button>
          </div>
          <div class="text-right">
            <button onclick="event.stopPropagation(); deletePot(${index})" class="text-red-500 text-xs">ðŸ—‘ Delete</button>
          </div>
          <div id="history-${index}" class="hidden mt-3 text-sm text-gray-700"></div>
        `;
        container.appendChild(potEl);
      });
    }

    function toggleHistory(index) {
      const historyDiv = document.getElementById(`history-${index}`);
      if (historyDiv.classList.contains('hidden')) {
        const history = transactions
          .filter(txn => txn.potIndex === index)
          .sort((a, b) => b.time - a.time)
          .map(txn => `<div>${new Date(txn.time).toLocaleString()}: ${txn.type} â‚¹${txn.amount}</div>`) // descending
          .join('');
        historyDiv.innerHTML = `<div class="border-t pt-2 mt-2">${history || 'No transactions yet.'}</div>`;
        historyDiv.classList.remove('hidden');
      } else {
        historyDiv.classList.add('hidden');
      }
    }

    function createPot() {
      const name = document.getElementById('potName').value;
      const goal = parseFloat(document.getElementById('potGoal').value);
      if (!name || isNaN(goal) || goal <= 0) return alert('Enter valid name and goal');
      pots.push({ name, goal, amount: 0 });
      savePots();
      renderPots();
      document.getElementById('potName').value = '';
      document.getElementById('potGoal').value = '';
      document.getElementById('formContainer').classList.add('hidden');
    }

    function addMoney(index) {
      const input = document.getElementById(`add-${index}`);
      const amount = parseFloat(input.value);
      if (isNaN(amount) || amount <= 0) return;
      pots[index].amount += amount;
      transactions.push({ potIndex: index, amount, type: 'Added', time: Date.now() });
      savePots();
      saveTransactions();
      renderPots();
    }

    function removeMoney(index) {
      const input = document.getElementById(`add-${index}`);
      const amount = parseFloat(input.value);
      if (isNaN(amount) || amount <= 0) return;
      pots[index].amount = Math.max(0, pots[index].amount - amount);
      transactions.push({ potIndex: index, amount, type: 'Removed', time: Date.now() });
      savePots();
      saveTransactions();
      renderPots();
    }

    function deletePot(index) {
      if (!confirm('Delete this pot?')) return;
      pots.splice(index, 1);
      transactions = transactions.filter(txn => txn.potIndex !== index);
      savePots();
      saveTransactions();
      renderPots();
    }

    window.onload = () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
      }
      renderPots();
    };
  </script>
</body>
</html>
